{% extends "base.html" %}
{% load static %}

{% block custom_css %}
<link rel="stylesheet" type="text/css" href="{% static 'outcomes/styles.css' %}">
{% endblock custom_css %}

{% block title %}
  Create Outcome | SIRIUS
{% endblock title %}

{% block content-main %}

{% if form.errors %}
    {% for field in form %}
        {% for error in field.errors %}
            <div class="alert alert-danger">
              <strong>Error on field "{{ field.label |capfirst }}": {{ error |escape }}</strong>
            </div>
        {% endfor %}
    {% endfor %}
    {% for error in form.non_field_errors %}
        <div class="alert alert-danger">
            <strong>{{ error|escape }}</strong>
        </div>
    {% endfor %}
{% endif %}

{% if outcomemedia_form.errors %}
    {% for error in outcomemedia_form.non_form_errors %}
        <div class="alert alert-danger">
            <strong>{{ error|escape }}</strong>
        </div>
    {% endfor %}
{% endif %}

<form 
  id="outcome-form" 
  class="custom-validation"
  method="post"
  data-sections-url="{% url 'outcomes:ajax-get-sections' %}"
  enctype="multipart/form-data"
  novalidate>
  {% csrf_token %}

  <div class="form-row">
    <div class="form-group bmd-form-group col-12">
      <label for="outcome_title" class="control-label bmd-label-static">{{form.title.label}}</label>
      {{ form.title }}
      <div class="invalid-feedback">
        Enter a title
      </div>
    </div>
  </div>

  <div class="form-row justify-content-between">
    <div class="form-group bmd-form-group col-12 col-lg-9">
      <label for="outcome_course" class="bmd-label-static">{{ form.course.label }}</label>
        {{ form.course }}
    </div>
    <div class="form-group bmd-form-group col-12 col-lg-2">
      <label for="outcome_course_section" class="bmd-label-static">{{ form.section.label }}</label>
      {{ form.section }}
    </div>
  </div>

  <div class="form-row justify-content-between">
    <div class="form-group bmd-form-group col-12 col-lg-9">
      <label for="outcome_semester" class="bmd-label-static">{{ form.semester.label }}</label>
        {{ form.semester }}
    </div>
    <div class="form-group bmd-form-group col-12 col-lg-2">
      <label for="outcome_year" class="bmd-label-static">{{ form.year.label }}</label>
      {{ form.year }}
    </div>
  </div>

  <div class="form-row">
    <div class="form-group bmd-form-group col-12">
      <label for="outcome_description" class="bmd-label-static">{{ form.description.label }}</label>
      {{ form.description }}
    </div>
  </div>

  {{ outcomemedia_form.management_form }}
  {{ outcomemediadirectory_form.management_form }}

  <div id="outcome-media-forms-row">
    <div id="outcome-media-forms">
      <label id="file_add" class="btn btn-outline-primary" for="id_media-0-media">+ Add a file</label>
      <label id="directory_add" class="btn btn-outline-primary" for="id_directory-0-media">+ Add a folder</label>
      {% for upload_form in outcomemedia_form %}
        {% include 'partials/media_upload.html' %}
      {% endfor %}
      {% for upload_form in outcomemediadirectory_form %}
        {% include 'partials/media_upload.html' %}
      {% endfor %}
    </div>
  </div>

  <div class="submit-row">
    <div class="mr-auto">
      <input type="Submit" class="btn btn-raised btn-primary" value="Post">
      {% block save_draft%}
      <input type="Submit" class="btn btn-danger" value="Save Draft" name="_save_draft">
      {% endblock save_draft %}
    </div>
    {% block back_navigate %}
    {% if request.META.HTTP_REFERER %}
    <a class="btn" href="{{ request.META.HTTP_REFERER }}">Cancel</a>
    {% else %}
    <a class="btn" href="{% url 'courses:subject-list' %}">Cancel</a>
    {% endif %}
    {% endblock back_navigate %}
  </div>
</form>

{% endblock content-main %}

{% block custom_js %}
<script type='text/javascript'>
    {% include 'partials/js/outcomemedia-formset-management.js' %}
</script>
<script type='text/javascript'>
'use strict';

(function () {
  function parseURL (text) {
    var xml = new window.DOMParser().parseFromString(text, 'text/xml')
    var tag = xml.getElementsByTagName('Key')[0]
    return decodeURI(tag.childNodes[0].nodeValue)
  }

  function addHiddenInput (body, name, form) {
    var key = parseURL(body)
    var input = document.createElement('input')
    input.type = 'hidden'
    input.value = key
    input.name = name
    form.appendChild(input)
  }

  function waitForAllFiles (form) {
    if (window.uploading !== 0) {
      setTimeout(function () {
        waitForAllFiles(form)
      }, 100)
    } else {
      window.HTMLFormElement.prototype.submit.call(form)
    }
  }

  function request (method, url, data, fileInput, file, form) {
    file.loaded = 0
    return new Promise(function (resolve, reject) {
      var xhr = new window.XMLHttpRequest()
      xhr.open(method, url)

      xhr.onload = function () {
        if (xhr.status === 201) {
          resolve(xhr.responseText)
        } else {
          reject(xhr.statusText)
        }
      }

      xhr.upload.onprogress = function (e) {
        var diff = e.loaded - file.loaded
        form.loaded += diff
        fileInput.loaded += diff
        file.loaded = e.loaded

        var defaultEventData = {
          currentFile: file,
          currentFileName: file.name,
          currentFileProgress: Math.min(e.loaded / e.total, 1),
          originalEvent: e
        }

        form.dispatchEvent(new window.CustomEvent('progress', {
          detail: Object.assign({
            progress: Math.min(form.loaded / form.total, 1),
            loaded: form.loaded,
            total: form.total
          }, defaultEventData)
        }))

        fileInput.dispatchEvent(new window.CustomEvent('progress', {
          detail: Object.assign({
            progress: Math.min(fileInput.loaded / fileInput.total, 1),
            loaded: fileInput.loaded,
            total: fileInput.total
          }, defaultEventData)
        }))
      }

      xhr.onerror = function () {
        reject(xhr.statusText)
      }

      xhr.send(data)
    })
  }

  function uploadFiles (form, fileInput, name) {
    var url = fileInput.getAttribute('data-url')
    fileInput.loaded = 0
    fileInput.total = 0
    var promises = Array.from(fileInput.files).map(function (file) {
      form.total += file.size
      fileInput.total += file.size
      var s3Form = new window.FormData()
      Array.from(fileInput.attributes).forEach(function (attr) {
        var name = attr.name

        if (name.startsWith('data-fields')) {
          name = name.replace('data-fields-', '')
          s3Form.append(name, attr.value)
        }
      })
      s3Form.append('success_action_status', '201')
      s3Form.append('Content-Type', file.type)
      s3Form.append('file', file)
      return request('POST', url, s3Form, fileInput, file, form)
    })
    Promise.all(promises).then(function (results) {
      results.forEach(function (result) {
        addHiddenInput(result, name, form)
      })
      var input = document.createElement('input')
      input.type = 'hidden'
      input.name = 's3file'
      input.value = fileInput.name
      fileInput.name = ''
      form.appendChild(input)
      window.uploading -= 1
    }, function (err) {
      console.log(err)
      fileInput.setCustomValidity(err)
      fileInput.reportValidity()
    })
  }

  function clickSubmit (e) {
    var submitButton = e.target
    var form = submitButton.closest('form')
    var submitInput = document.createElement('input')
    submitInput.type = 'hidden'
    submitInput.value = submitButton.value || '1'
    submitInput.name = submitButton.name
    form.appendChild(submitInput)
  }

  function uploadS3Inputs (form) {
    window.uploading = 0
    form.loaded = 0
    form.total = 0
    var inputs = form.querySelectorAll('.s3file')
    Array.from(inputs).forEach(function (input) {
      window.uploading += 1
      uploadFiles(form, input, input.name)
    })
    waitForAllFiles(form)
  }

  document.addEventListener('DOMContentLoaded', function () {
    var forms = Array.from(document.querySelectorAll('.s3file')).map(function (input) {
      return input.closest('form')
    })
    forms = new Set(forms)
    forms.forEach(function (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault()
        uploadS3Inputs(e.target)
      })
      var submitButtons = form.querySelectorAll('input[type=submit], button[type=submit]')
      Array.from(submitButtons).forEach(function (submitButton) {
        submitButton.addEventListener('click', clickSubmit)
      })
    })
  })
})()
</script>
<script src="{% static 'js/get-course-sections.js'%}" type='text/javascript'></script>
<script>$('#outcome_title').disableAutoFill();</script>
{% endblock custom_js %}
